package files

import (
	"bytes"
	"sync"
	"unicode/utf8"
)

var russianUnicodeDecode = map[[3]byte][]byte{
	{228, 128, 129}: {208, 144}, {228, 128, 130}: {208, 160}, {228, 128, 131}: {208, 176}, {228, 128, 132}: {209, 128},
	{228, 128, 144}: {208, 129}, {228, 128, 145}: {208, 145}, {228, 128, 146}: {208, 161}, {228, 128, 147}: {208, 177},
	{228, 128, 148}: {209, 129}, {228, 128, 149}: {209, 145}, {228, 128, 161}: {208, 146}, {228, 128, 162}: {208, 162},
	{228, 128, 163}: {208, 178}, {228, 128, 164}: {209, 130}, {228, 128, 177}: {208, 147}, {228, 128, 178}: {208, 163},
	{228, 128, 179}: {208, 179}, {228, 128, 180}: {209, 131}, {228, 129, 129}: {208, 148}, {228, 129, 130}: {208, 164},
	{228, 129, 131}: {208, 180}, {228, 129, 132}: {209, 132}, {228, 129, 145}: {208, 149}, {228, 129, 146}: {208, 165},
	{228, 129, 147}: {208, 181}, {228, 129, 148}: {209, 133}, {228, 129, 161}: {208, 150}, {228, 129, 162}: {208, 166},
	{228, 129, 163}: {208, 182}, {228, 129, 164}: {209, 134}, {228, 129, 177}: {208, 151}, {228, 129, 178}: {208, 167},
	{228, 129, 179}: {208, 183}, {228, 129, 180}: {209, 135}, {228, 130, 129}: {208, 152}, {228, 130, 130}: {208, 168},
	{228, 130, 131}: {208, 184}, {228, 130, 132}: {209, 136}, {228, 130, 145}: {208, 153}, {228, 130, 146}: {208, 169},
	{228, 130, 147}: {208, 185}, {228, 130, 148}: {209, 137}, {228, 130, 161}: {208, 154}, {228, 130, 162}: {208, 170},
	{228, 130, 163}: {208, 186}, {228, 130, 164}: {209, 138}, {228, 130, 177}: {208, 155}, {228, 130, 178}: {208, 171},
	{228, 130, 179}: {208, 187}, {228, 130, 180}: {209, 139}, {228, 131, 129}: {208, 156}, {228, 131, 130}: {208, 172},
	{228, 131, 131}: {208, 188}, {228, 131, 132}: {209, 140}, {228, 131, 145}: {208, 157}, {228, 131, 146}: {208, 173},
	{228, 131, 147}: {208, 189}, {228, 131, 148}: {209, 141}, {228, 131, 161}: {208, 158}, {228, 131, 162}: {208, 174},
	{228, 131, 163}: {208, 190}, {228, 131, 164}: {209, 142}, {228, 131, 177}: {208, 159}, {228, 131, 178}: {208, 175},
	{228, 131, 179}: {208, 191}, {228, 131, 180}: {209, 143},
}

var russianUnicodeEncode = map[[2]byte][]byte{
	{208, 144}: {228, 128, 129}, {208, 160}: {228, 128, 130}, {208, 176}: {228, 128, 131}, {209, 128}: {228, 128, 132},
	{208, 129}: {228, 128, 144}, {208, 145}: {228, 128, 145}, {208, 161}: {228, 128, 146}, {208, 177}: {228, 128, 147},
	{209, 129}: {228, 128, 148}, {209, 145}: {228, 128, 149}, {208, 146}: {228, 128, 161}, {208, 162}: {228, 128, 162},
	{208, 178}: {228, 128, 163}, {209, 130}: {228, 128, 164}, {208, 147}: {228, 128, 177}, {208, 163}: {228, 128, 178},
	{208, 179}: {228, 128, 179}, {209, 131}: {228, 128, 180}, {208, 148}: {228, 129, 129}, {208, 164}: {228, 129, 130},
	{208, 180}: {228, 129, 131}, {209, 132}: {228, 129, 132}, {208, 149}: {228, 129, 145}, {208, 165}: {228, 129, 146},
	{208, 181}: {228, 129, 147}, {209, 133}: {228, 129, 148}, {208, 150}: {228, 129, 161}, {208, 166}: {228, 129, 162},
	{208, 182}: {228, 129, 163}, {209, 134}: {228, 129, 164}, {208, 151}: {228, 129, 177}, {208, 167}: {228, 129, 178},
	{208, 183}: {228, 129, 179}, {209, 135}: {228, 129, 180}, {208, 152}: {228, 130, 129}, {208, 168}: {228, 130, 130},
	{208, 184}: {228, 130, 131}, {209, 136}: {228, 130, 132}, {208, 153}: {228, 130, 145}, {208, 169}: {228, 130, 146},
	{208, 185}: {228, 130, 147}, {209, 137}: {228, 130, 148}, {208, 154}: {228, 130, 161}, {208, 170}: {228, 130, 162},
	{208, 186}: {228, 130, 163}, {209, 138}: {228, 130, 164}, {208, 155}: {228, 130, 177}, {208, 171}: {228, 130, 178},
	{208, 187}: {228, 130, 179}, {209, 139}: {228, 130, 180}, {208, 156}: {228, 131, 129}, {208, 172}: {228, 131, 130},
	{208, 188}: {228, 131, 131}, {209, 140}: {228, 131, 132}, {208, 157}: {228, 131, 145}, {208, 173}: {228, 131, 146},
	{208, 189}: {228, 131, 147}, {209, 141}: {228, 131, 148}, {208, 158}: {228, 131, 161}, {208, 174}: {228, 131, 162},
	{208, 190}: {228, 131, 163}, {209, 142}: {228, 131, 164}, {208, 159}: {228, 131, 177}, {208, 175}: {228, 131, 178},
	{208, 191}: {228, 131, 179}, {209, 143}: {228, 131, 180},
}

func encodeDecode(data []byte) []byte {
	var (
		result = make([][]byte, len(data))
		wg     sync.WaitGroup
	)

	for i := 0; i < len(data); i++ {
		b := data[i]
		switch b {
		case 34, 51, 68, 85, 102, 119:
			result[i] = []byte{b}
			continue
		case 194, 195:
			if i+1 < len(data) {
				r, _ := utf8.DecodeRune(data[i : i+2])
				b = nibbleSwap(byte(r))
				result[i] = []byte(string(b))
				i++
				continue
			}
		case 208, 209:
			if i+1 < len(data) {
				key := [2]byte{b, data[i+1]}
				if v, ok := russianUnicodeEncode[key]; ok {
					result[i] = v
					i++
					continue
				}
			}
		case 228:
			if i+2 < len(data) {
				key := [3]byte{b, data[i+1], data[i+2]}
				if v, ok := russianUnicodeDecode[key]; ok {
					result[i] = v
					i += 2
					continue
				}
			}
		}

		wg.Add(1)
		go func(i int, b byte) {
			defer wg.Done()
			b = nibbleSwap(b)
			result[i] = []byte(string(b))
		}(i, b)
	}

	wg.Wait()

	return bytes.Join(result, nil)
}

func nibbleSwap(b byte) byte {
	return (b << 4 & 0xF0) | (b >> 4 & 0x0F)
}
